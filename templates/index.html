{% extends "base.html" %}

{% block title %}ã€ä¸­å­¦ç”Ÿç‰ˆã€‘AIå­¦ç¿’ã‚¢ãƒ—ãƒªï¼ˆmanabuwaï¼‰{% endblock %}

{% block content %}
<div class="hero-section">
    <div class="container">
        <div class="hero-content">
            <h2 class="hero-title">
                <i class="fas fa-seedling"></i>
                ä¸€æ­©ãšã¤å­¦ã¶ã‚ã€AIã¨ä¸€ç·’ã«ã€‚
            </h2>
            <p class="hero-description">
                741ã®å­¦ç¿’æŒ‡å°è¦é ˜é …ç›®ã‹ã‚‰ã€ä»Šã®æ°—åˆ†ã‚„èˆˆå‘³ã«åˆã‚ã›ã¦è‡ªç”±ã«é¸ã‚“ã§ãã ã•ã„ã€‚ä¸€æ­©ãšã¤ã€ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§é€²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ã€‚
            </p>
            <!-- åŸºæœ¬ãƒ†ã‚¹ãƒˆ -->
            <button onclick="alert('åŸºæœ¬ãƒ†ã‚¹ãƒˆæˆåŠŸ!');" style="background: #ff6b6b; color: white; padding: 10px 20px; border: none; border-radius: 8px; margin-top: 1rem; cursor: pointer;">
                <i class="fas fa-bug"></i> åŸºæœ¬ãƒ†ã‚¹ãƒˆ
            </button>
            
            <!-- ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«å•é¡Œã‚’ä¿®æ­£ã™ã‚‹ãŸã‚ä¸€æ™‚çš„ã«ç„¡åŠ¹åŒ– -->
            <p style="color: #666; margin-top: 1rem; font-size: 0.9rem;">ãƒãƒ¥ãƒ¼ãƒˆãƒªã‚¢ãƒ«æ©Ÿèƒ½ã¯ç¾åœ¨ä¿®æ­£ä¸­ã§ã™ã€‚</p>
        </div>
    </div>
</div>

<div class="container">

    <!-- ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆãªæ¤œç´¢ãƒ»é€²æ—ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚¨ãƒªã‚¢ -->
    <section class="compact-header-section">
        <div class="search-progress-container">
            <div class="search-filter-area">
                <div class="search-box-compact">
                    <div class="search-input-wrapper-compact">
                        <input type="text" id="searchInput" placeholder="ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã€è­˜åˆ¥å­ã§æ¤œç´¢..." class="search-input-compact">
                        <button onclick="performSearch()" class="search-btn-compact">
                            <i class="fas fa-search"></i>
                        </button>
                    </div>
                </div>
                <div class="subject-filters-compact">
                    <button class="filter-btn-compact active" onclick="filterBySubject('all')">
                        <i class="fas fa-globe"></i>
                        ã™ã¹ã¦
                    </button>
                    {% for subject in subjects %}
                    <button class="filter-btn-compact" onclick="filterBySubject('{{ subject }}')">
                        {% if subject == "å›½èª" %}
                            <i class="fas fa-pen-nib"></i>
                        {% elif subject == "ç®—æ•°" or subject == "æ•°å­¦" %}
                            <i class="fas fa-calculator"></i>
                        {% elif subject == "ç†ç§‘" %}
                            <i class="fas fa-flask"></i>
                        {% elif subject == "ç¤¾ä¼š" %}
                            <i class="fas fa-globe-asia"></i>
                        {% elif subject == "è‹±èª" %}
                            <i class="fas fa-language"></i>
                        {% else %}
                            <i class="fas fa-book"></i>
                        {% endif %}
                        {{ subject }}
                    </button>
                    {% endfor %}
                </div>
            </div>
        </div>
    </section>

    {% for subject, items in content_by_subject.items() %}
    <section class="identifiers-section subject-section" data-subject="{{ subject }}">
        <h3 class="section-title">
            {% if subject == "å›½èª" %}
                <i class="fas fa-pen-nib"></i>
            {% elif subject == "ç®—æ•°" or subject == "æ•°å­¦" %}
                <i class="fas fa-calculator"></i>
            {% elif subject == "ç†ç§‘" %}
                <i class="fas fa-flask"></i>
            {% elif subject == "ç¤¾ä¼š" %}
                <i class="fas fa-globe-asia"></i>
            {% elif subject == "è‹±èª" %}
                <i class="fas fa-language"></i>
            {% else %}
                <i class="fas fa-book"></i>
            {% endif %}
            {{ subject }} ({{ items|length }}ä»¶)
        </h3>
        <div class="identifiers-grid">
            {% for item in items %}
            <div class="identifier-card" data-identifier="{{ item.identifier }}" data-total-goals="{{ item.total_goals }}" title="{{ item.learning_prompt }}">
                <div class="card-icon">
                    {% if subject == "å›½èª" %}
                        <i class="fas fa-pen-nib"></i>
                    {% elif subject == "ç®—æ•°" or subject == "æ•°å­¦" %}
                        <i class="fas fa-calculator"></i>
                    {% elif subject == "ç†ç§‘" %}
                        <i class="fas fa-flask"></i>
                    {% elif subject == "ç¤¾ä¼š" %}
                        <i class="fas fa-globe-asia"></i>
                    {% elif subject == "è‹±èª" %}
                        <i class="fas fa-language"></i>
                    {% else %}
                        <i class="fas fa-file-alt"></i>
                    {% endif %}
                </div>
                <div class="card-content">
                    <div class="card-header">
                        <h4 class="card-title">{{ item.identifier }}</h4>
                    </div>
                    <p class="card-description">{{ item.learning_objective|truncate(80) }}</p>
                    <div class="card-keywords">
                        {% for keyword in item.keywords[:3] %}
                        <span class="keyword-mini">{{ keyword }}</span>
                        {% endfor %}
                        {% if item.keywords|length > 3 %}
                        <span class="keyword-more">+{{ item.keywords|length - 3 }}</span>
                        {% endif %}
                    </div>
                    <div class="card-progress" data-identifier="{{ item.identifier }}">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: 0%;"></div>
                        </div>
                        <span class="progress-text">0%</span>
                    </div>
                </div>
                <div class="card-arrow">
                    <i class="fas fa-chevron-right"></i>
                </div>
            </div>
            {% endfor %}
        </div>
    </section>
    {% endfor %}

    <!-- å…¨é€²æ—å‰Šé™¤ã‚»ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæœ€ä¸‹éƒ¨ï¼‰ -->
    <section class="reset-section">
        <div class="reset-container">
            <details class="reset-details">
                <summary class="reset-summary">
                    <i class="fas fa-cog"></i> è©³ç´°è¨­å®š
                </summary>
                <div class="reset-content">
                    <div class="reset-warning">
                        <i class="fas fa-exclamation-triangle"></i>
                        <span>å±é™ºãªæ“ä½œï¼šå…¨ã¦ã®å­¦ç¿’é€²æ—ãŒå‰Šé™¤ã•ã‚Œã¾ã™</span>
                    </div>
                    <button class="btn-reset-all" onclick="resetAllProgress()">
                        <i class="fas fa-trash-alt"></i> å…¨é€²æ—ã‚’å‰Šé™¤
                    </button>
                </div>
            </details>
        </div>
    </section>
</div>

<script>
function performSearch() {
    const searchInput = document.getElementById('searchInput');
    const searchTerm = searchInput.value.trim().toLowerCase();
    
    if (!searchTerm) {
        // ç©ºã®å ´åˆã¯å…¨ã¦è¡¨ç¤º
        document.querySelectorAll('.identifier-card').forEach(card => {
            card.style.display = 'flex';
        });
        return;
    }
    
    const cards = document.querySelectorAll('.identifier-card');
    let hasResults = false;
    
    cards.forEach(card => {
        const identifier = card.querySelector('.card-title').textContent.toLowerCase();
        const description = card.querySelector('.card-description').textContent.toLowerCase();
        const keywords = Array.from(card.querySelectorAll('.keyword-mini')).map(k => k.textContent.toLowerCase()).join(' ');
        
        if (identifier.includes(searchTerm) || description.includes(searchTerm) || keywords.includes(searchTerm)) {
            card.style.display = 'flex';
            hasResults = true;
        } else {
            card.style.display = 'none';
        }
    });
    
    // æ¤œç´¢çµæœãŒãªã„å ´åˆã®è¡¨ç¤º
    if (!hasResults) {
        showSearchNoResults(searchTerm);
    } else {
        hideSearchNoResults();
    }
}

function showSearchNoResults(searchTerm) {
    // æ—¢å­˜ã®ã€Œçµæœãªã—ã€ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å‰Šé™¤
    hideSearchNoResults();
    
    const container = document.querySelector('.container');
    const noResultsDiv = document.createElement('div');
    noResultsDiv.id = 'searchNoResults';
    noResultsDiv.className = 'search-no-results';
    noResultsDiv.innerHTML = `
        <div class="no-results-content">
            <i class="fas fa-search"></i>
            <h3>ã€Œ${searchTerm}ã€ã®æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</h3>
            <p>åˆ¥ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã§æ¤œç´¢ã—ã¦ã¿ã¦ãã ã•ã„</p>
            <button onclick="clearSearch()" class="btn-clear-search">æ¤œç´¢ã‚’ã‚¯ãƒªã‚¢</button>
        </div>
    `;
    
    // æœ€åˆã®sectionã®å‰ã«æŒ¿å…¥
    const firstSection = container.querySelector('.identifiers-section');
    if (firstSection) {
        container.insertBefore(noResultsDiv, firstSection);
    }
}

function hideSearchNoResults() {
    const existing = document.getElementById('searchNoResults');
    if (existing) {
        existing.remove();
    }
}

function clearSearch() {
    document.getElementById('searchInput').value = '';
    performSearch();
    hideSearchNoResults();
}

function viewContent(identifier) {
    window.location.href = `/content/${identifier}`;
}

function filterBySubject(subject) {
    // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¢ã‚¯ãƒ†ã‚£ãƒ–çŠ¶æ…‹ã‚’æ›´æ–°
    document.querySelectorAll('.filter-btn-compact').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // ã‚»ã‚¯ã‚·ãƒ§ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
    document.querySelectorAll('.subject-section').forEach(section => {
        if (subject === 'all' || section.dataset.subject === subject) {
            section.style.display = 'block';
        } else {
            section.style.display = 'none';
        }
    });
    
    // æ¤œç´¢çµæœè¡¨ç¤ºã‚’ã‚¯ãƒªã‚¢
    hideSearchNoResults();
}


// é€²æ—ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°æ©Ÿèƒ½
function updateProgressDashboard() {
    try {
        // é€²æ—ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦è¡¨ç¤ºã‚’æ›´æ–°
        if (window.progressManager) {
            const stats = window.progressManager.getOverallStats();
            
            // ãƒ¡ã‚¤ãƒ³é€²æ—ç‡
            const progressPercentage = Math.round(stats.overallPercentage);
            
            // è¦ç´ ã®å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãã§æ›´æ–°
            const mainProgressPercentage = document.getElementById('mainProgressPercentage');
            if (mainProgressPercentage) mainProgressPercentage.textContent = progressPercentage + '%';
            
            const mainProgressText = document.getElementById('mainProgressText');
            if (mainProgressText) mainProgressText.textContent = progressPercentage + '%';
            
            // å††å½¢ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è§’åº¦ã‚’è¨­å®š
            const mainProgressCircle = document.getElementById('mainProgressCircle');
            if (mainProgressCircle) {
                const progressAngle = (progressPercentage / 100) * 360;
                mainProgressCircle.style.setProperty('--progress-angle', progressAngle + 'deg');
            }
            
            // çµ±è¨ˆæ•°å€¤æ›´æ–°ï¼ˆè¦ç´ å­˜åœ¨ãƒã‚§ãƒƒã‚¯ä»˜ãï¼‰
            const completedItems = document.getElementById('completedItems');
            if (completedItems) completedItems.textContent = stats.completedItems;
            
            const completedGoals = document.getElementById('completedGoals');
            if (completedGoals) completedGoals.textContent = stats.completedGoals.toLocaleString();
            
            const totalItems = document.getElementById('totalItems');
            if (totalItems) totalItems.textContent = stats.totalItems;
            
            // é”æˆãƒãƒƒã‚¸ã¨ãƒ¢ãƒãƒ™ãƒ¼ã‚·ãƒ§ãƒ³ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’æ›´æ–°
            updateAchievementBadge(progressPercentage);
            updateMotivationMessage(progressPercentage, stats.completedItems);
        }
    } catch (error) {
        console.error('âŒ updateProgressDashboard ã‚¨ãƒ©ãƒ¼:', error);
    }
}

function updateAchievementBadge(percentage) {
    try {
        const badge = document.getElementById('achievementBadge');
        if (!badge) return;
        
        const badgeIcon = badge.querySelector('i');
        if (!badgeIcon) return;
        
        if (percentage >= 90) {
            badgeIcon.className = 'fas fa-crown';
            badge.style.background = 'linear-gradient(135deg, #ffd700, #ffb347)';
        } else if (percentage >= 75) {
            badgeIcon.className = 'fas fa-trophy';
            badge.style.background = 'linear-gradient(135deg, #ff9800, #f57c00)';
        } else if (percentage >= 50) {
            badgeIcon.className = 'fas fa-star';
            badge.style.background = 'linear-gradient(135deg, #4caf50, #388e3c)';
        } else if (percentage >= 25) {
            badgeIcon.className = 'fas fa-leaf';
            badge.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        } else {
            badgeIcon.className = 'fas fa-seedling';
            badge.style.background = 'linear-gradient(135deg, #667eea, #764ba2)';
        }
    } catch (error) {
        console.error('âŒ updateAchievementBadge ã‚¨ãƒ©ãƒ¼:', error);
    }
}

function updateMotivationMessage(percentage, completedItems) {
    try {
        const messageElement = document.getElementById('motivationMessage');
        if (!messageElement) return;
        
        const messageSpan = messageElement.querySelector('span');
        const messageIcon = messageElement.querySelector('i');
        if (!messageSpan || !messageIcon) return;
        
        let message = '';
        let icon = 'fas fa-heart';
        
        if (percentage >= 90) {
            message = `ğŸ‰ ç´ æ™´ã‚‰ã—ã„ï¼${completedItems}é …ç›®ã‚‚å®Œäº†ã—ã¾ã—ãŸï¼ã‚ãªãŸã¯å­¦ç¿’ã®ãƒãƒ£ãƒ³ãƒ”ã‚ªãƒ³ã§ã™ï¼`;
            icon = 'fas fa-crown';
        } else if (percentage >= 75) {
            message = `ğŸ† é©šç•°çš„ãªé€²æ­©ã§ã™ï¼${completedItems}é …ç›®å®Œäº†ã€‚ã‚´ãƒ¼ãƒ«ã¾ã§ã‚ã¨å°‘ã—ï¼`;
            icon = 'fas fa-trophy';
        } else if (percentage >= 50) {
            message = `â­ åŠåˆ†ä»¥ä¸Šé”æˆï¼${completedItems}é …ç›®ã®æˆæœã¯ç´ æ™´ã‚‰ã—ã„ã§ã™ï¼`;
            icon = 'fas fa-star';
        } else if (percentage >= 25) {
            message = `ğŸŒ¿ é †èª¿ã«æˆé•·ä¸­ï¼${completedItems}é …ç›®å®Œäº†ã€‚ã“ã®èª¿å­ã§ç¶šã‘ã¾ã—ã‚‡ã†ï¼`;
            icon = 'fas fa-leaf';
        } else if (completedItems > 0) {
            message = `ğŸŒ± å­¦ç¿’ã®æ—…ãŒå§‹ã¾ã‚Šã¾ã—ãŸï¼${completedItems}é …ç›®å®Œäº†ã€‚ä¸€æ­©ãšã¤é€²ã‚“ã§ã„ãã¾ã—ã‚‡ã†ï¼`;
            icon = 'fas fa-seedling';
        } else {
            message = 'å­¦ç¿’ã®æ—…ã‚’å§‹ã‚ã¾ã—ã‚‡ã†ï¼ä¸€æ­©ãšã¤ã€ã‚ãªãŸã®ãƒšãƒ¼ã‚¹ã§ã€‚';
            icon = 'fas fa-heart';
        }
        
        messageIcon.className = icon;
        messageSpan.textContent = message;
    } catch (error) {
        console.error('âŒ updateMotivationMessage ã‚¨ãƒ©ãƒ¼:', error);
    }
}

// DOMãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã‹ã‚‰ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¨­å®š
document.addEventListener('DOMContentLoaded', function() {
    // Enterã‚­ãƒ¼ã§ã®æ¤œç´¢ã‚’æœ‰åŠ¹ã«ã™ã‚‹
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        searchInput.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                performSearch();
            }
        });
        
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ æ¤œç´¢ï¼ˆå…¥åŠ›ä¸­ï¼‰
        searchInput.addEventListener('input', function() {
            if (this.value.trim() === '') {
                // ç©ºã®å ´åˆã¯å…¨ã¦è¡¨ç¤º
                document.querySelectorAll('.identifier-card').forEach(card => {
                    card.style.display = 'flex';
                });
                hideSearchNoResults();
            } else {
                performSearch();
            }
        });
    }
    
    // ã‚«ãƒ¼ãƒ‰ã‚¯ãƒªãƒƒã‚¯ã§è©³ç´°ãƒšãƒ¼ã‚¸ã¸é·ç§»
    document.querySelectorAll('.identifier-card').forEach(card => {
        card.addEventListener('click', function(event) {
            // ãƒœã‚¿ãƒ³ã‚„ãƒªãƒ³ã‚¯ãªã©ã€ç‰¹å®šã®è¦ç´ ã®ã‚¯ãƒªãƒƒã‚¯ã¯é™¤å¤–
            if (event.target.closest('button, a, .card-progress, .achievement-badge')) {
                return;
            }
            const identifier = this.dataset.identifier;
            if (identifier) {
                viewContent(identifier);
            }
        });
    });
    
    // åˆå›ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰æ›´æ–°
    setTimeout(updateProgressDashboard, 100);
    
    // progress-managerãŒãƒ­ãƒ¼ãƒ‰ã•ã‚ŒãŸå¾Œã«å†æ›´æ–°
    setTimeout(updateProgressDashboard, 1000);
});

// ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°é€²æ—ã‚«ãƒ¼ãƒ‰é–¢æ•°
function toggleFloatingProgress() {
    const details = document.getElementById('floatingProgressDetails');
    const icon = document.getElementById('floatingToggleIcon');
    const card = document.getElementById('floatingProgressCard');
    
    if (details.style.display === 'none' || !details.style.display) {
        details.style.display = 'block';
        icon.className = 'fas fa-chevron-down';
        card.classList.add('expanded');
    } else {
        details.style.display = 'none';
        icon.className = 'fas fa-chevron-up';
        card.classList.remove('expanded');
    }
}

// ã‚°ãƒ­ãƒ¼ãƒãƒ«é–¢æ•°ã¨ã—ã¦å…¬é–‹
window.updateProgressDashboard = updateProgressDashboard;
</script>


{% endblock %}